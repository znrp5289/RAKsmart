# iOS 内购（IAP）自动续订订阅类型详解

## 一、iOS 内购类型概览

iOS 应用内购（IAP）主要分为四种类型：

1. **消耗型商品**  
   只能使用一次的产品，使用后即失效，需再次购买。  
   **示例**：游戏中的鱼食。

2. **非消耗型商品**  
   只需购买一次，不会过期或随着使用而减少的产品。  
   **示例**：游戏中的赛道。

3. **自动续期订阅**  
   允许用户在固定时间段内购买动态内容，除非用户取消，否则订阅会自动续期。  
   **示例**：流媒体服务的月度订阅。

4. **非续期订阅**  
   允许用户购买一定时限的服务，订阅不会自动续期。  
   **示例**：为期一年的归档文章目录订阅。

在开发过程中，**自动续期订阅**是最复杂的一类，因为它涉及**免费试用期**、**促销期**、**取消续订**和**恢复续订**等操作，后台逻辑也更为复杂。以下将详细介绍自动续期订阅的实现细节。

---

## 二、自动续订订阅的实现要点

### 1. App 专用共享密钥

自动续订订阅需要一个**“App 专用共享密钥”**，用于接收并验证订阅收据（receipt）。该密钥需传递给苹果服务器进行票据校验。若需将 App 转让给其他开发者，或设置主共享密钥为专用，则必须使用此密钥。

![共享密钥](//upload-images.jianshu.io/upload_images/1802326-5892de248ac8bc78.png)

### 2. 订阅群组

订阅群组允许开发者向用户提供一系列内容供应、服务等级或时限。每个群组下可以有多个自动续订订阅，但用户一次只能订阅一个群组中的一个选项。若需用户同时购买多个订阅，可将这些订阅放在不同的群组中。

![订阅群组](//upload-images.jianshu.io/upload_images/1802326-f9c8e755ec9ea6d8.png)

### 3. 订阅状态 URL

自动续订订阅需配置**订阅状态 URL**，以便后台接收苹果服务器的通知（server to server）。该 URL 会在订阅状态发生变化时触发通知。

![订阅状态 URL](//upload-images.jianshu.io/upload_images/1802326-ef0e80333e00611c.png)

### 4. 推介促销优惠

推介促销优惠用于吸引新用户，例如**免费试用期**或**折扣优惠**。每个群组下每个用户只能享受一次促销优惠。

| 优惠类型       | 描述                                                                 |
|----------------|----------------------------------------------------------------------|
| 随用随付       | 用户按结算周期支付折扣价格（如前 3 个月每月 1.99 美元）。              |
| 提前支付       | 用户一次性支付选定时限的折扣价格（如前 2 个月 1.99 美元）。            |
| 免费           | 用户在选定时限内免费访问订阅（如 7 天免费试用）。                      |

---

## 三、iOS 内购流程

### 1. 流程概述

1. 用户发起购买请求，苹果服务器完成支付。  
2. 购买成功后，App 请求服务器验证票据。  
3. 服务器接收并存储票据，发送至苹果服务器验证，并返回结果给客户端。

### 2. 具体实现

- **启动时添加监听**  
  在 App 启动时需添加以下代码，以接收苹果推送的自动续订通知：  
  objc
  [[SKPaymentQueue defaultQueue] addTransactionObserver:self];
  

- **交易完成后执行 finishTransaction**  
  交易结束后必须调用 `finishTransaction`，否则可能导致重复通知或异常：  
  objc
  [[SKPaymentQueue defaultQueue] finishTransaction:transaction];
  

---

## 四、服务端验证

自动续订订阅的票据验证可通过服务器端完成，以确保数据安全性。苹果服务器会通过以下通知类型更新订阅状态：

| 通知类型              | 描述                                                                 |
|-----------------------|----------------------------------------------------------------------|
| **INITIAL_BUY**        | 初次购买订阅。                                                       |
| **CANCEL**             | 用户取消订阅。                                                       |
| **RENEWAL**            | 过期订阅自动续订成功。                                               |
| **INTERACTIVE_RENEWAL** | 用户通过界面续订订阅。                                               |
| **DID_CHANGE_RENEWAL_PREF** | 用户更改了续订计划（下个周期生效）。                                |

---

## 五、沙盒测试注意事项

在沙盒环境中，测试订阅的时限会缩短：

| 实际时限 | 测试时限 |
|----------|----------|
| 1 周     | 3 分钟   |
| 1 个月   | 5 分钟   |
| 2 个月   | 10 分钟  |
| 3 个月   | 15 分钟  |
| 6 个月   | 30 分钟  |

注意：沙盒测试无法模拟用户手动取消订阅的场景。

---

## 六、关于审核

### 1. 自动续订说明

自动续订订阅需在 App 和 App Store Connect 中明确说明，包括续订条款和取消方法。

### 2. 登录要求

苹果规定，所有内购应绑定 Apple ID，因此 App 应支持游客模式购买。

---

👉 [WildCard | 一分钟注册，轻松订阅海外线上服务](https://bbtdd.com/WildCard) 

---

通过以上内容，希望开发者能更好地理解和实现 iOS 自动续订订阅功能。